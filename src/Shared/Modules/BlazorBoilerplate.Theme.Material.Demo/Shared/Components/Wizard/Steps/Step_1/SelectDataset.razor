@inject IStringLocalizer<Global> L
@using System
@inject IApiClient apiClient
@inject IViewNotifier viewNotifier

<div style="display:flex; flex-direction:row; align-items:center">
    <MatSelect Label="Pick a data type" @bind-Value="dataTypeValue">
        <MatOptionString Value="tab">Tabular data</MatOptionString>
        <MatOptionString Value="image">Image data</MatOptionString>
    </MatSelect>
    <MatButton TrailingIcon="add" OnClick="@(e => { _isTabularUploadOpen = true; })">Upload</MatButton>
</div>

@*<MatChipSet Choice="true" @bind-SelectedChip="selectedChip">
    <MatChip Id="tab" Label="Tabular data"></MatChip>
    <MatChip Id="image" Label="Image Data"></MatChip>
</MatChipSet>
<MatButton TrailingIcon="add" OnClick="@(e => { _isTabularUploadOpen = true; })">Upload</MatButton>*@

@if (dataTypeValue == "tab")
{ 
<DatasetTable DatasetResponse="_datasets" @bind-SelectedDataset="_selectedDataset" GoNext="GoNext"></DatasetTable>
}

@*<MatTabGroup>
        <MatTab Label="Tabular data">
            <MatButton TrailingIcon="add" OnClick="@(e => { _isTabularUploadOpen = true; })">Upload</MatButton>
            <DatasetTable DatasetResponse="_datasets" @bind-SelectedDataset="_selectedDataset"></DatasetTable>
        </MatTab>
        <MatTab Label="Image data">
        </MatTab>
    </MatTabGroup>*@

<UploadTabularDataset @bind-IsOpen="_isTabularUploadOpen" OnUploadCompletedCallback="LoadDatasets"></UploadTabularDataset>

@code {
    private StartAutoMLRequestDto _selectedDataset
    {
        get => SelectedDataset;
        set
        {
            SelectedDatasetChanged.InvokeAsync(value);
            CheckForNextStepCallback.InvokeAsync();
        }
    }
    [Parameter]
    public StartAutoMLRequestDto SelectedDataset { get; set; }

    [Parameter]
    public EventCallback<StartAutoMLRequestDto> SelectedDatasetChanged { get; set; }

    /// <summary>
    /// Trigger to start examination for IsNextStepApproved in Parent
    /// </summary>
    [Parameter]
    public EventCallback CheckForNextStepCallback { get; set; }

    [Parameter]
    public EventCallback GoNext { get; set; }

    private List<GetDatasetsResponseDto> _datasets;
    private bool _isTabularUploadOpen = false;
    private string dataTypeValue = "tab";

    protected override async Task OnInitializedAsync()
    {
        await LoadDatasets();
        _selectedDataset.DatasetName = null;
    }

    private async Task LoadDatasets()
    {
        try
        {
            _datasets = new List<GetDatasetsResponseDto>();
            ApiResponseDto apiResponse = await apiClient.GetDatasets();

            if (apiResponse.IsSuccessStatusCode)
            {
                _datasets = Newtonsoft.Json.JsonConvert.DeserializeObject<List<GetDatasetsResponseDto>>(apiResponse.Result.ToString());
                StateHasChanged();
                viewNotifier.Show(apiResponse.Message, ViewNotifierType.Success, L["Operation Successful"]);
            }
            else
            {
                viewNotifier.Show(apiResponse.Message + " : " + apiResponse.StatusCode, ViewNotifierType.Error, L["Operation Failed"]);
            }
        }
        catch (Exception ex)
        {
            viewNotifier.Show(ex.GetBaseException().Message, ViewNotifierType.Error, L["Operation Failed"]);
        }
    }
}
